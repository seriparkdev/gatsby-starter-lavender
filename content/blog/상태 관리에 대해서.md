---
title: 상태 관리에 대해서
date: 2023-02-10
description: 바보 같은 삽질 후에 깨달은 것들
tags: [project, state]
---

# 서론

Redux-Toolkit을 전역 상태 관리를 위해 프로젝트에 사용했다. 프로젝트를 진행하면서 무언가 잘못 되어 가는 느낌, 잘못 사용하고 있다는 느낌이 들었다. 종종 원하는 대로 결과가 나오지 않고, 내가 짠 코드에 확신이 들지 않아서 고민을 시작했다. 이 글은 그 고민에 대한 내용이다.

# 이상한 오류들

## 텅 빈 객체

오류와 관련된 프로젝트 구조이다.

- 메인 페이지

- 계좌 리스트 페이지

- 유저 리스트 페이지

계좌 리스트 페이지와 유저 리스트 페이지 둘 다 서버에서 가져오는 users, accounts라는 데이터가 필요했다. 사진과 같이 계좌 리스트 페이지에서는 유저의 이름을 표시해야 하고, 유저 리스트 페이지에서는 유저가 가지고 있는 계좌의 개수가 몇 개인지 표시해주어야 했기 때문이다.

<br>

<img src="https://velog.velcdn.com/images/seripark/post/932659ef-b451-444a-ab42-ef409661068d/image.jpg" >

<br>

<img src="https://velog.velcdn.com/images/seripark/post/8f11a4ae-ee73-42b9-9c53-5325ba979e85/image.jpg" width="250px">

<br>

그래서 나는 계좌 리스트 페이지에서 accounts를 서버에서 가져오는 액션을 dispatch 했고, 유저 정보 페이지에서는 store에 접근해서 accounts를 가져왔다. 네트워크 통신을 줄여보고자 이런 로직을 구상했었다.

가져오는 방법이 뭐가 더 좋은지에 대한 고민은 있었지만 이 로직은 그래도 원하는 대로 작동해줄 것이라고 생각했다. 그리고 계좌 개수를 실제로 잘 가져오고 있어서 문제 없다고 생각한 뒤 바로 다음으로 구현해야 할 기능을 구현하기 시작했다. 프로젝트를 계속 진행하던 와중에 유저 리스트 페이지에 들어가보니 계좌의 개수가 제대로 뜨지 않고 모두 0으로 표시 되고 있었다.

얼마 전까지만 해도 잘 됐었는데 내가 개발을 하면서 뭘 잘못 건드렸나?라는 의문에 콘솔에서 리덕스 개발자 도구로 액션을 확인했다. 그런데 accounts 자체에 아무런 데이터가 없었다. 그래서 accounts를 불러오는 계좌 리스트 페이지로 이동했는데 데이터가 잘 표시되고 있었다. 의문스러워서 다시 유저 리스트 페이지로 이동했는데 유저들의 계좌 수가 잘 표시 되고 있었다.

계좌 리스트 페이지에서는 서버에서 계좌를 가지고 오는 액션을 dispatch 해주고 있기 때문에 계좌 리스트 페이지를 거치고 나서 유저 리스트 페이지로 가면 계좌 정보가 잘 들어오지만, 메인 페이지에서 계좌 리스트 페이지를 거치지 않고 바로 유저 리스트 페이지로 가면 계좌 정보가 들어오지 않는 것이었다.

그래서 나는 유저 리스트에서 accounts를 dispatch해서 가져오는 것으로 우선 해결을 했다. 네트워크 통신을 줄여보고자 했지만 결국 유저 리스트에서는 users와 accounts도 가져오게 됐다. 이게 너무 좋지 않은 방법처럼 느껴졌는데 해결 방법이 떠오르지 않았다. 그래서 고민을 하며 다른 기능을 구현하다가 다른 에러를 또 마주하게 됐다.

## 이상하게 많은 데이터들

```JSX
const getUsers = async () => {
    const response = await dispatch(getUsersThunk({ _page: page, _limit: 15 }));
    setHasMore(response.payload.length === 15);
  };
```

다음과 같이 페이지네이션에서 무한 스크롤로 기능을 변경하고 데이터를 15개씩 가져오도록 설정해놨다. 그런데 어느 날 보니 스크롤 하지 않았음에도 모든 데이터가 띄워져 있었다. 메인 페이지에서 바로 유저 리스트 페이지를 들어가면 문제가 없었으나, 계좌 리스트 페이지에 들어갔다가 유저 리스트 페이지에 들어가면 문제가 생기는 것을 확인할 수 있었다.

이런 버그들을 겪으면서 최상단 컴포넌트에서 데이터를 서버로부터 가져오는 액션을 dispatch하고 자식 컴포넌트에서는 store에서 값을 가져오면 쉽게 상태를 관리할 수 있지 않을까?라고 가정을 해봤다. 근데 네트워크의 비용을 줄이기 위해서는 데이터를 필요로 하는 시점에서 데이터를 불러오는 것이 옳은 방향이기 때문에 이런 방향은 좋기 때문에 이런 식의 리팩토링을 하지 않았다.

# 원인

두 이상한 에러를 살펴보면 공통점이 있다. 특수한 어떤 페이지를 거쳐서 다른 페이지로 올 때만 에러가 생긴다는 것이다. **이미 데이터를 가져와서 store에 저장해두었기 때문에 다른 페이지로 이동했을 때면 dispatch를 하지 않아도 모든 데이터를 가지고 있던 것이다.** 그럼 이 데이터는 어떻게 관리했던 게 맞을까?

고민을 하다가 공부를 해야겠다는 생각이 들었고 내가 프로젝트 하면서 스스로 어려움을 왜 느꼈는지에 대해 정리해봤다.

- **상태 관리**에 대한 기준이 없고, 지식이 부족하다

- **전역**으로 관리해야 할 데이터와 그렇지 않은 데이터를 구분하는 기준이 없다

- **상태 관리 라이브러리**를 어떻게 써야 옳은 것인지 모르겠다

그리고 이 내용을 바탕으로 공부를 했다. 이어지는 내용에는 공부했던 내용과 내가 했던 생각에 대해 정리해봤다.

# 상태

상태란 무엇일까? React에서 상태란 렌더링에 영향을 주는 자바스크립트 객체라고 말한다. 상태는 상수와 같이 고정된 것이 아니고 변하는 값이며 렌더링을 야기시키는 것이다.

그렇다면 프론트엔드에서 상태란 무엇일까? 이렇게 나눠볼 수 있다.

- 서버에서 가져오는 동적인 데이터

- UI 상태

앞서 언급했던 accounts나 users 같은 것들이 서버에서 가져오는 동적인 데이터고, UI 상태는 모달의 open 여부 같은 것이다.

## client state / server state

이런 client state와 server state의 차이는 무엇일까?

<br>

<table>
    <tr>
        <th>client state</th>
        <th>server state</th>
    </tr>
    <tr>
        <td>client에서 소유, 제어 가능</td>
        <td>client에서 소유 가능, 제어 가능(원격 공간에서 유지, 관리)</td>
   
   
  <tr>
        <td>초기값 설정, 조작에 제약사항 X</td>
        <td>Fetching/Updating에 비동기 API 필요</td>
   
   
  <tr>
        <td>다른 사람과 공유 X, client 내에서 UI/UX 흐름 혹은 사용자 인터렉션에 따라 변할 수 있음</td>
        <td>다른 사람과 공유 O, 사용자가 모르는 사이에 변경 가능</td>
   
   
  <tr>
        <td>항상 client 내에서 최신 상태로 관리됨</td>
        <td>관리하지 않으면 out of date 될 수 있음</td>
   
</table>

<br>

client state의 주도권은 client가 가지고 server state의 주도권은 server가 가진다는 것을 유의하고 각 state에 맞게 관리해줘야 한다.

# 전역 상태 관리 라이브러리 / 서버 상태 관리 라이브러리

그럼 이런 상태를 다루는 라이브러리에 대해 알아보자. 나는 `React-Query`와 `Recoil`를 같이 많이 사용한다는 얘기를 들으면서 의아함을 가져왔다. 둘 중 하나로 상태 관리를 다 할 수 있는데 왜 Recoil까지 사용하는지 그 이유를 알 수 없었기 때문이다. 둘은 어떤 차이가 존재할까?

## Redux의 문제점

<img src="https://user-images.githubusercontent.com/1474579/188503591-4473d9d5-85fe-469a-b1ea-c01fdcc6cefd.png">

<br>

Redux의 문제점에 대해 얘기하면서 알아가보자.

Redux는 언제 필요할까? 전역 상태 관리를 위해서, props drilling을 피하기 위해서 필요할 것이다. 그런데, **Redux store에서 서버에서 가져오는 데이터를 관리하는 건 조금 문제가 있다.** Redux의 공식 문서를 읽어보면 Redux는 `Single source of Truth`라는 원칙을 가지고 있는데 서버에서 가져오는 데이터를 클라이언트 메모리에 저장하는 것은 **서버 메모리에도, 클라이언트 메모리에도 데이터가 존재하는 것**이고, **Redux store에 저장되어 있는 데이터가 과연 진실하다고 말하기 어렵다**는 것이다. 서버를 떠나서 데이터를 store에 저장한 그 순간에 캡쳐된 데이터인데 이 데이터가 계속해서 신뢰할만하다고 말하기는 어렵다는 것이다. 액션을 dispatch할 때까지 이 데이터는 out of date 상태이기 때문이다.

## stale-while-revalidate

그럼 데이터를 어떻게 최신 상태로 관리할 수 있을까?

```
Cache-Control: max-age=1, stale-while-revalidate=59
```

이는 HTTP에서 제공하는 Cache-Control이다. max-age를 확인해서 만료되지 않았다면 아무런 작업을 하지 않고, 만료 되었다면 stale-while-revalidate 값을 확인한다. stale-while-revalidate 값을 넘지 않았다면 캐싱된 값을 반환하고, 데이터 요청을 해서 최신화를 한다. stale-while-revalidate의 값을 넘었다면 바로 데이터를 새로 요청해서 최신화를 한다.

이 전략을 사용하면 데이터를 최신으로 잘 유지할 수 있다. 이런 stale-while-revalidate 컨셉을 도입한 것이 `react-query`, `swr`, `rtk-query`이다. rtk-query는 Redux 팀에서 이런 문제점을 해결하기 위해 만들어낸 것이다.

<br>

<img src="https://miro.medium.com/v2/resize:fit:1400/1*3mo5cnETB_DoxBGjkHXE_w.png" width="230px">

<br>

다시 React-Query와 Recoil에 대한 이야기로 넘어가서 각 라이브러리가 담당해야 하는 state는 뭘까? React-Query에서는 비동기 통신과 관련된 최적화가 되어있으니 이와 관련된 상태들은 React-Query를 통해 관리하고 Recoil로는 client state를 관리하면 된다.

나는 Redux-Toolkit을 사용하면서 rtk-query의 존재에 대해 몰랐고 서버 상태를 관리하기 위해서는 다른 로직을 추가적으로 구현해야 한다거나, 서버 상태만을 관리하기 위한 라이브러리가 필요하다는 사실을 몰랐기 때문에 계속해서 문제가 발생했던 것 같다.

# 전역 상태

그럼 전역으로 관리해줘야 하는 상태란 무엇이 있을까? 생각보다 전역 상태로 관리해야 할 것들은 많지 않은 것 같다. 프로젝트를 통해서 전역 상태로 관리하지 않아도 될 것들을 과도하게 관리하려고 하면 부작용이 따른다는 것을 배웠다. 특정 상태가 여러 컴포넌트에 필요하다면 컴포넌트를 전체적으로 provider로 감쌀 것 없이 필요한 컴포넌트에만 적용 시켜줘도 된다. 이를 고려하면 프로젝트가 작을 수록 전역적으로 상태를 관리할 상황이 많고, 프로젝트가 클 수록 전역적으로 상태를 관리할 필요가 없어진다.

# 맺으면서

그동안 프로젝트를 하면서 막연하게 가졌던 의문들이 해소되고 지식을 얻었다. 굉장히 엉뚱한 에러를 내면서 내가 체계 없이 상태 관리를 하고, 지식도 많이 부족했었구나를 깨닫게 됐다. 앞으론 개발을 하기 전에 상태를 어떻게 관리할지 구상을 해보는 연습을 많이 해보려고 한다. 그러면서 다음 프로젝트에서는 rtk-query를 공부하고 사용해서 rtk 하나로 프로젝트의 전반적인 상태를 관리해보고 싶다.

<br>

**참고 문서**

[전역 상태 관리에 대한 단상 (stale-while-revalidate)](https://jbee.io/react/thinking-about-global-state/)

[React Query와 상태관리](https://www.youtube.com/watch?v=MArE6Hy371c&t=2195s)
